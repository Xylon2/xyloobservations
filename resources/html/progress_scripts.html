<script type="text/javascript" src="/js/jquery-3.6.0.min.js"></script>
<script>
function refreshImage(image_id) {
    $.get('/image_deets_ajax?id='.concat(image_id), function(image) {
        $("#theimage").attr("srcset", `${image.full_prefix}_tiny.${image.sizes.tiny.extension} ${image.sizes.tiny.width}w,
              ${image.full_prefix}_small.${image.sizes.small.extension} ${image.sizes.small.width}w,
              ${image.full_prefix}_medium.${image.sizes.medium.extension} ${image.sizes.medium.width}w`);

        $("#theimage").attr("sizes", `(max-width: 640px) ${image.sizes.tiny.width}px,
             (max-width: 960px) ${image.sizes.small.width}px,
             ${image.sizes.medium.width}px`);
        $("#theimage").attr("src", `${image.full_prefix}_tiny.${image.sizes.tiny.extension}`);
    });
}

function doPoll(image_id) {
    $.get('/image_progress?image_id='.concat(image_id), function(data) {
      // if it's a success or error our job is done. else keep polling
      if (["success","error"].includes(data["msgtype"])) {
        setMessage(data);
        $("#ajaxsubmit").prop("disabled", false);

        if ("{{ progresstype }}" === "crop") {
            // we need to reload the image, which means re-writing it's srcset, sizes and src
            refreshImage(image_id);
        }
      } else {
        setMessage(data);
        setTimeout(doPoll, 1000, image_id);
      }
    });
}

function setMessage(data)
{
  switch (data["msgtype"]) {
    case "info":
      $("#message").css("color", "blue");
      break
    case "success":
      $("#message").css("color", "green");
      break
    default:
      $("#message").css("color", "red");
  }
  if (data["msgtxt"] !== null) {
    $("#message").text(data["msgtxt"]);
  }
}

$(function() {
    // hang on event of form with id=myform
    $("#ajaxform").submit(function(e) {

        // prevent Default functionality
        e.preventDefault();

        if ($('#newimage').val() === "") {
          $("#message").css("color", "red");
          $("#message").text("don't forget to choose a file");
          return;
        }

        // disable the form. update the message
        $("#ajaxsubmit").prop("disabled", true);
        $("#message").css("color", "blue");
        switch("{{ progresstype }}") {
            case "upload":
              $("#message").text("uploading.......");
              break;
            case "crop":
              $("#message").text("pending.........");
              break;
        }

        // get the action-url of the form
        var actionurl = e.currentTarget.action;

        // make our AJAX request and handle the results
        $.ajax({
                url: actionurl,
                type: 'post',
                dataType: 'JSON',
                data: new FormData(this),
                processData: false,
                contentType: false,
                success: function(data, status) {
                  setMessage(data);

                  // the AJAX query was a success but is the response message a success?
                  if (data["msgtype"] !== "error") {
                    if ("{{ progresstype }}" === "upload") {
                      $('#ajaxform').trigger("reset");
                    }

                    var image_id = data["image_id"];
                    doPoll(image_id);
                  }
                },
                error: function (xhr, status, err)
                {   
                  var msg = '';
                  if (xhr.status === 0) {
                      msg = 'Not connected.\n Verify Network.';
                  } else if (xhr.status == 404) {
                      msg = 'Requested page not found. [404]';
                  } else if (xhr.status == 500) {
                      msg = 'Internal Server Error [500].';
                  } else if (status === 'parsererror') {
                      msg = 'Requested JSON parse failed.';
                  } else if (status === 'timeout') {
                      msg = 'Time out error.';
                  } else if (status === 'abort') {
                      msg = 'Ajax request aborted.';
                  } else {
                      msg = 'Uncaught Error.\n' + xhr.responseText;
                  }
                  $("#message").css("color", "red");
                  $("#message").text(msg);
                  $("#ajaxsubmit").prop("disabled", false)
                }
        });

    });

});
</script>
